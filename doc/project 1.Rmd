---
title: "R Notebook"
output: html_notebook
---

1. Gender study of three authors
2. 

```{r}

library("xts")
# install.packages("dplyr")
library('dplyr') # data manipulation
# library('readr') # input/output
# library('data.table') # data manipulation
# install.packages('tibble')
library('tibble') # data wrangling
# library('tidyr') # data wrangling
# library('stringr') # string manipulation
# library('forcats') # factor manipulation


# install.packages('tidytext')
library('tidytext')
# install.packages("magrittr")
library('magrittr')
# install.packages("tidyr")
library("tidyr")
# install.packages("ggplot2")
library("ggplot2")

# install.packages("plotly")
library("plotly")

# install.packages("pamr")
library("pamr")
```

Data preparation

```{r}

# We want to treat each column as characters, not factors, except for the author column.
spooky <- read.csv('../data/spooky.csv', colClasses = 'character')
spooky <- as.tibble(spooky)
spooky$author <- as.factor(spooky$author)
summary(spooky)

```

Tokenization
```{r fig.keep="last"}
# First use tidytext function to drop the punctuations and tokenize our file.
pronouns <- c("he","she")
data <- spooky %>%
  unnest_tokens(word, text, token = "ngrams", n = 2, to_lower = TRUE, drop = TRUE)
# Then we get rid of the stop words ("words that are not useful for an analysis, typically extremely common words such as “the”, “of”, “to”, and so forth in English.")
# tidytext has a dictionary for stop words.
# data(stop_words)
# data <- data %>%
#   anti_join(stop_words, by = "word")

data_counts <- data %>%
  count(word, sort = TRUE) %>%
  separate(word, c("word1","word2"), sep = " ", remove = TRUE) %>%
  filter(word1 %in% pronouns) %>%
  count(word1, word2, wt = n, sort = TRUE) %>%
  rename(counts = "nn")

temp <- data.frame(
  count(data_counts, word1)
)
ggplot(temp, aes(x="", y=n, fill=word1))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start = 0)


MWS_po <- data_counts_by_author %>%
  filter(author == "MWS") %>%
  count(word1) %>%
  rename(pronoun = "word1", counts = "nn")
HPL_po <- data_counts_by_author %>%
  filter(author == "HPL") %>%
  count(word1) %>%
  rename(pronoun = "word1", counts = "nn")
EAP_po <- data_counts_by_author %>%
  filter(author == "EAP") %>%
  count(word1) %>%
  rename(pronoun = "word1", counts = "nn")

p1 <- ggplot(MWS_po, aes(x="", y=counts, fill=pronoun))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start = 0)
p2 <- ggplot(HPL_po, aes(x="", y=counts, fill=pronoun))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start = 0)
p3 <- ggplot(EAP_po, aes(x="", y=counts, fill=pronoun))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start = 0)

  

# frequency <- data %>% 
#   count(author, word) %>%
#   group_by(author) %>%
#   mutate(proportion = n / sum(n)) %>%
#   select(-n) %>%
#   spread(author, proportion) %>%
#   gather(author, proportion, c("EAP","MWS"))
# 
# ggplot(frequency, aes(x = proportion, y = 'HPL'))

word_ratios <- data_counts %>%
    group_by(word2) %>%
    filter(sum(counts) > 10) %>%
    ungroup() %>%
    spread(word1, counts, fill = 0) %>%
    mutate_if(is.numeric, funs((. + 1) / sum(. + 1))) %>%
    mutate(logratio = log2(she / he)) %>%
    arrange(desc(logratio))   

# Equally likely:
word_ratios %>%
  arrange(abs(logratio))

# Large difference:
word_ratios %>%
    mutate(abslogratio = abs(logratio)) %>%
    group_by(logratio < 0) %>%
    top_n(15, abslogratio) %>%
    ungroup() %>%
    mutate(word = reorder(word2, logratio)) %>%
    ggplot(aes(word, logratio, color = logratio < 0)) +
    geom_segment(aes(x = word, xend = word,
                     y = 0, yend = logratio), 
                 size = 1.1, alpha = 0.6) +
    geom_point(size = 3.5) +
    coord_flip() +
    labs(x = NULL, 
         y = "Relative appearance after 'she' compared to 'he'",
         title = "Words paired with 'he' and 'she'",
         subtitle = "Women throw, sleep, and turn while men####") +
    scale_color_discrete(name = "", labels = c("More 'she'", "More 'he'")) +
    scale_y_continuous(breaks = seq(-3, 3),
                       labels = c("0.125x", "0.25x", "0.5x", 
                                  "Same", "2x", "4x", "8x"))

data_counts_by_author <- data %>%
  count(author, word, sort = TRUE) %>%
  separate(word, c("word1","word2"), sep = " ", remove = TRUE) %>%
  filter(word1 %in% pronouns)
```

```{r}
pamr.menu(data_counts)

khan.data <- pamr.from.excel("../data/spooky.csv", 65, sample.labels=TRUE)


```


